reaction.Controller=function(a,b){this._conf=a||reaction.conf();b=b||reaction.message;this._reactionButtons=new reaction.Buttons(this._conf,b[this._conf.language]);this._reactionFriends=reaction.Friends?new reaction.Friends(this._conf,b[this._conf.language]):null;this._attachEvent();};reaction.Controller.prototype={constructor:reaction.Controller,_attachEvent:function(){var b=jQuery.proxy(function(c,d){this._clicklog(c,d);},this);var a=jQuery(this._reactionButtons);a.on("clickReaction",b);if(this._reactionFriends){a.on("successReaction",jQuery.proxy(function(c,d){if(!d.isNeoid&&d.friendsLayerId){if(d.isAdding){this._reactionFriends.show(d);}else{this._reactionFriends.hide(d);}}},this));jQuery(this._reactionFriends).on("connectLineId",b).on("closeLineIdConnectionWithCache",b).on("closeLineIdConnection",b).on("shareTimelineOnce",b).on("shareTimelineAlways",b).on("closeTimelineShareWithCache",b).on("closeTimelineShare",b).on("setTimelineShare",b).on("launchApp",b);}},_detachEvent:function(){jQuery(this._reactionButtons).off();jQuery(this._reactionFriends).off();},_destroy:function(){this._detachEvent();this._reactionButtons._destroy();},_clicklog:function(b,f){var c=f.event,e=f.target,a=jQuery(e).attr("data-log"),d;if(!a){return;}if(b.type==="clickReaction"){d=a.split("|");a=f.isAdding?d[0]:d[1];}!!(a)&&reaction.clicklog(e,a,c);},update:function(a,b){jQuery("."+this._conf.moduleClassname).css("visibility","visible");this._reactionButtons.update(a,b);return this;}};reaction.Buttons=function(a,b){this._resources={content:"/v1/search/contents?suppress_response_codes=true",contentAdd:"/v1/services/{serviceId}/contents/{contentsId}?suppress_response_codes=true&_method=POST",contentCancel:"/v1/services/{serviceId}/contents/{contentsId}?suppress_response_codes=true&_method=DELETE"};this._conf=a;this._messages=b;this._isNeoid=(this._conf.authType==="neoid");this._isNeoid&&this._setNeoidResources();this._$body=jQuery(document);this._onButtonHandler=jQuery.proxy(this._onButtonHandler,this);this._onHideHandler=jQuery.proxy(this._onHideHandler,this);this._onFaceButtonHandler=jQuery.proxy(this._onFaceButtonHandler,this);this._attachEvent();};reaction.Buttons.prototype={constructor:reaction.Buttons,_setNeoidResources:function(){jQuery.extend(this._resources,{content:this._conf.authInfo.domain+"/v1/search/contents?suppress_response_codes=true&token="+this._conf.authInfo.token+"&consumerKey="+this._conf.authInfo.consumerKey+"&snsCode="+this._conf.authInfo.snsCode+"&pool="+this._conf.authInfo.pool,contentAdd:this._conf.authInfo.domain+"/v1/services/{serviceId}/contents/{contentsId}?suppress_response_codes=true&_method=POST&token="+this._conf.authInfo.token+"&consumerKey="+this._conf.authInfo.consumerKey+"&snsCode="+this._conf.authInfo.snsCode+"&pool="+this._conf.authInfo.pool,contentCancel:this._conf.authInfo.domain+"/v1/services/{serviceId}/contents/{contentsId}?suppress_response_codes=true&_method=DELETE&token="+this._conf.authInfo.token+"&consumerKey="+this._conf.authInfo.consumerKey+"&snsCode="+this._conf.authInfo.snsCode+"&pool="+this._conf.authInfo.pool});},_attachEvent:function(){this._$body.on("click",this._onHideHandler).on("click","."+this._conf.moduleClassname+" a._face",this._onFaceButtonHandler).on("click","."+this._conf.moduleClassname+" a._button",this._onButtonHandler);},_onHideHandler:function(a){var b=jQuery(a.target);if(this._conf.isHiddenLayerAfterSelection||(!b.hasClass("_button")&&!b.hasClass("_face"))){this._hideLayers();}},_onFaceButtonHandler:function(b){var c=jQuery(b.currentTarget);if(c){var a=c.parent().find("._faceLayer").first();if(a.is(":visible")){a.hide();}else{this._hideLayers();a.show();}}b.stopPropagation();},_getCountButton:function(a){return a.find("._count").first();},_onButtonHandler:function(a){var c=a.currentTarget,b=!jQuery(c).hasClass(this._conf.iconToggleClassname[0]),d={event:a.originalEvent,target:c,isAdding:b};!jQuery(c).closest("._face + ._faceLayer").length&&this._hideLayers();a.preventDefault();if(b){this.increase(c);}else{this.decrease(c);}jQuery(this).trigger("clickReaction",d);},_hideLayers:function(){var a;jQuery(jQuery.grep(jQuery("."+this._conf.moduleClassname).find("._faceLayer:visible"),function(b){a=jQuery(b);return a.is(":visible")&&!!a.parent().find("._face").length;})).hide();},_detachEvent:function(){this._$body.off("click","."+this._conf.moduleClassname+" a._button",this._onButtonHandler).off("click",this._onHideHandler).off("click","."+this._conf.moduleClassname+" a._face",this._onFaceButtonHandler);},_isAndroidConfirmBugInApp:function(){return/Android 5.+Chrome\/40.+NAVER.+inapp/.test(navigator.userAgent);},_redirectLogin:function(a){if(this._isAndroidConfirmBugInApp()||confirm(a)){if(this._isNeoid){this._conf.authInfo.loginHandler();}else{top.location.href="https://nid.naver.com/nidlogin.login?"+(this._conf.isMobile?"svctype=262144":"")+"url="+encodeURIComponent(location.href)+"&locale="+(this._conf.language==="ko"?"ko_KR":"en_US");}}},_updateReactionFromClient:function(c,e,b){var a=[];var d=null;var f="."+this._conf.moduleClassname;c.each(jQuery.proxy(function(h,j){var m=jQuery(j),g=m.closest(f).first(),l=this._isFace(g),k=g.attr("data-duplication")||!!this._conf.isDuplication;k=typeof k==="boolean"?k:(k+"").toLowerCase()==="true";if(!k){if(b){this._cleanReaction(b.get(h),e===false?false:undefined);}else{d=g.find((l?"._faceLayer ":"")+"."+this._conf.iconToggleClassname[0]);d=d.is(m)?d.not(m):d;if(!l){var n=m.parent();d=d.filter(function(p,o){var i=jQuery(o);var q=i.parent();return((q.attr("data-sid")!==n.attr("data-sid"))||(q.attr("data-cid")!==n.attr("data-cid"))||(i.attr("data-type")!==m.attr("data-type")));});}this._cleanReaction(d,true);}}a.push(d);this._updateButton(g,m,e,this._toNum(this._getCountButton(m).text())+(e?1:-1));l&&this._updateFaceButton(g.find("._face").first());},this));return jQuery(a);},_cleanReaction:function(c,e){var a=this,d,b;c.length&&c.each(function(f,g){d=jQuery(g).toggleClass(a._conf.iconToggleClassname.join(" "));b=a._getCountButton(d);b.text(a._formattedCount(a._toNum(b.text())+(typeof e==="undefined"?0:(e?-1:1))));});},_requestReaction:function(k,c){var b=jQuery(k),h=b.closest("."+this._conf.moduleClassname),e=jQuery().add(b),a=h.attr("data-sid"),m=h.attr("data-cid"),d=h.attr("data-pid"),f=h.attr("data-catgid")||"",j=h.attr("data-did")||a,o=h.attr("data-friendslayer-id")||"",n=b.attr("data-type"),g=b.attr("data-viewtype")||"",r=h.attr("data-duplication")||!!this._conf.isDuplication,s={displayId:j,reactionType:n,categoryId:f,guestToken:reaction._guestToken,timestamp:reaction._timestamp,_ch:this._conf.isMobile?"mbw":"pcw",isDuplication:typeof r==="boolean"?r:(r+"").toLowerCase()==="true",lang:this._conf.language},q={$base:h,$target:b,serviceId:a,contentId:m,displayId:j,friendsLayerId:o,reactionType:n,reactionViewType:g,isAdding:c,isNeoid:this._isNeoid},p;if(c){p="contentAdd";s.isPostTimeline=!!(o);}else{p="contentCancel";}if(!!g){s.viewType=g;}if(!!d){s.parentContentsId=d;}var l=jQuery("."+this._conf.moduleClassname).not(h).filter(function(){var t=jQuery(this);return t.attr("data-sid")===a&&t.attr("data-cid")===m;}).find("._button[data-type="+n+"]");if(l.length){e=e.add(l);}var i=this._updateReactionFromClient(e,c);jQuery.ajax({url:(this._isNeoid?"":this._conf.domain)+this._resources[p].replace("{serviceId}",a).replace("{contentsId}",m),dataType:"jsonp",scriptCharset:"utf-8",timeout:3000,data:s,context:this,success:function(t){if(!t.errorCode){if(t.snsInfo){q.snsInfo=t.snsInfo;}jQuery(this).trigger("successReaction",q);this._conf.callback&&this._conf.callback.clicked&&this._conf.callback.clicked({targets:e.get(),content:t});this._triggerParentCallback(t);}else{if(t.errorCode===4010){this._updateReactionFromClient(e,!c,i);this._redirectLogin(t.message);}else{this._updateReactionFromClient(e,!c,i);alert(t.message);jQuery(this).trigger("errorReaction",q);}}},error:function(){this._updateReactionFromClient(e,!c,i);alert(this._messages.error);jQuery(this).trigger("errorReaction",q);}});},_getRequestQueue:function(a){var c=this,e=[],b=[],f=-1,d=-1;a.each(function(){var h=jQuery(this),k=h.attr("data-domain")||c._conf.domain,l=h.attr("data-sid"),n=h.attr("data-cid"),m=h.attr("data-pid"),j=h.attr("data-duplication")||!!c._conf.isDuplication,g,i;j=typeof j==="boolean"?j:(j+"").toLowerCase()==="true";f=jQuery.inArray(k,b);if(f<0||(e[f].duplication!==j)){b.push(k);f=b.length-1;e[f]={domain:k,duplication:j,services:[]};}d=jQuery.map(e[f].services,function(o){return o.serviceId;}).indexOf(l);if(d<0){e[f].services.push({serviceId:l,contentIds:[],parentIds:[]});d=e[f].services.length-1;}g=e[f].services[d].contentIds;i=e[f].services[d].parentIds;(!~jQuery.inArray(n,g))&&g.push(n);m&&(!~jQuery.inArray(m,i))&&i.push(m);});return e;},_convertToParamString:function(c,a){var e=[];for(var b=0,d=c.length;b<d;b++){c[b][a].length&&e.push(c[b].serviceId+"["+c[b][a].join(",")+"]");}return e.join("|");},_convertToMapData:function(a){var b={};jQuery.each(a,function(d,e){var f={};var c=!!("parentReactions" in e);jQuery.each(e[c?"parentReactions":"reactions"],function(g,h){f[h.reactionType]=h;});if(c){b[e.serviceId]=b[e.serviceId]||{};b[e.serviceId][e.parentContentsId]=f;}else{b[e.serviceId+"_"+e.contentsId]=f;}});return b;},_triggerParentCallback:function(a){this._conf.callback&&a.parentContents&&this._conf.callback.updateParent&&this._conf.callback.updateParent(this._convertToMapData(a.parentContents));},_requestContentList:function(a){var f=this._getRequestQueue(a),h=function(){console.warn("XHR ERROR");},g=jQuery.proxy(function(i){if(!i.errorCode){this._drawButtons(a,this._convertToMapData(i.contents));reaction._guestToken=i.guestToken||"";reaction._timestamp=i.timestamp||"";this._conf.callback&&this._conf.callback.updated&&this._conf.callback.updated({targets:a.get(),contents:i.contents});this._triggerParentCallback(i);}},this);for(var b=0,e,c,d=f.length;b<d;b++){e={q:this._convertToParamString(f[b].services,"contentIds"),isDuplication:f[b].duplication};c=this._convertToParamString(f[b].services,"parentIds");c&&(e.pq=c);jQuery.ajax({url:this._isNeoid?this._resources.content:f[b].domain+this._resources.content,dataType:"jsonp",scriptCharset:"utf-8",timeout:3000,data:e,context:this,success:g,error:h});}},_drawButtons:function(a,c){var b=this;a.each(function(g,h){var f=jQuery(h),d=c[f.attr("data-sid")+"_"+f.attr("data-cid")];if(d){f.find("._button").each(function(l,k){var n=jQuery(k),m=n.attr("data-type"),o=d[m]||{},j=n.attr("data-viewtype")||m;if(b._isDrawingByTemplate(f,n)){n.html(b._conf.buttonTemplate.replace("{label}",b._messages.label[j]));}b._updateButton(f,n,o.isReacted,o.count);});b._drawFaceButtons(f,d);f.attr("data-loaded","1");var e=f.find("._faceLayer");if(f.attr("data-isOpenFaceLayer")==="true"){f.find("._faceLayer").show();}f.attr("data-facetype",e.length);}});},_drawFaceButtons:function(d,c){var b=d.find("._face").first();if(!b.length){return;}var f=false;var a=0;var e=[];for(var g in c){if(c[g].isReacted){f=true;}a+=c[g].count;e.push({type:g,count:c[g].count});}if(this._isDrawingByTemplate(d,b)){var h=b.attr("data-label")||"default";b.html(this._conf.faceButtonTemplate.replace("{label}",this._messages.face[h]));}this._makeFaceIcons(d,b);this._updateFaceButton(b,f,e,a);},_makeFaceIcons:function(e,g){var a=this._conf.faceButtonMaxIconCount;if(a<=0){return;}if(e.attr("data-loaded")!=="1"){var c=g.find("._icons").first();var d=c.children();var h=a-d.length;if(h>0){var b=d.first();for(var f=0;f<h;f++){b.clone().hide().appendTo(c);}}else{if(h<0){jQuery(d.splice(a)).each(function(k,j){jQuery(j).remove();});}}}},_isDrawingByTemplate:function(a,b){return a.attr("data-loaded")!=="1"&&!jQuery.trim(b.html());},_updateButton:function(b,e,d,c){if(!e.length){return;}var a=this._getVisibleOptionOfButton(e);this._updateClassButton(e,d,this._isFace(b)?"aria-selected":"aria-pressed");this._updateIconInButton(e,d,a);this._updateLabelInButton(e,c,a);this._updateCountInButton(e,c,a);},_updateFaceButton:function(a,f,g,h){if(!a.length){return;}g=g||[];var d;if(typeof f==="undefined"&&typeof count==="undefined"){f=(a.parent().find("._button."+this._conf.iconToggleClassname[0]).length>0);h=0;var i=this;var c=0;var b;a.parent().find("._button ._count").each(function(k,j){d=jQuery(j);b=d.parent().attr("data-type");c=i._toNum(d.text());h+=c;g.push({type:b,count:c});});}g=jQuery.grep(g,function(j){return j.count!==0;}).sort(function(j,k){if(j.count===k.count){if(j.type==="like"){return -1;}else{if(k.type==="like"){return 1;}}}else{return k.count-j.count;}});var e=a.attr("data-label")||"default";d=this._getCountButton(a);if(h){d.html(this._formattedCount(h,a.attr("data-maxcount"))).addClass("num");}else{d.html(this._messages.face[e]).removeClass("num");}this._updateFaceButtonIcons(a,g);this._updateClassButton(a,f,"aria-pressed");},_updateFaceButtonIcons:function(h,e){var g=h.find("._icons").first();if(!g.length){return;}var f=g.children();var j;var d;for(var b=0,c=this._conf.faceButtonMaxIconCount,a=e.length;b<c;b++){if(a>b){j=f.eq(b).show();d=e[b].type;this._updateIconsByType(j,d);j.css("zIndex",c-b+1).find("span").html(this._messages.label[d]);}else{if(b===0){if(a===0){this._updateIconsByType(f.eq(b),"like");}}else{f.eq(b).hide();}}}},_updateIconsByType:function(b,d){var c=b.get(0);var a=c.className.split(" ");c.className=jQuery.grep(a,function(e){return !/^__reaction__/.test(e);}).join(" ")+" __reaction__"+d;},_updateCountInButton:function(e,d,c){var b=this._getCountButton(e),a=d||0,f=!(c.isHiddenCount||(a===0&&(c.isHiddenZeroCount||c.isUsedLabelAsZeroCount)));b.length&&b.html(this._formattedCount(a,e.attr("data-maxcount"))).toggle(f);},_formattedCount:function(d,a){var c=0,f=a||this._conf.maxCount,b=Math.max(c,Math.min(d,f)).toString(),e=b.replace(/(\d)(?=(\d{3})+$)/igm,"$1,"),g=(d>f)?"+":"";return e+g;},_getValueOfPrioritizedOption:function(b,c){var e=this._conf[c],a=b.attr("data-"+c),d=e;if(a!==undefined&&a!==null){d=(typeof a==="boolean"&&!!a)||(a==="true")||!!(parseInt(a,10));}return d;},_getVisibleOptionOfButton:function(a){return{isHiddenIcon:this._getValueOfPrioritizedOption(a,"isHiddenIcon"),isHiddenLabel:this._getValueOfPrioritizedOption(a,"isHiddenLabel"),isHiddenCount:this._getValueOfPrioritizedOption(a,"isHiddenCount"),isHiddenZeroCount:this._getValueOfPrioritizedOption(a,"isHiddenZeroCount"),isUsedLabelAsZeroCount:this._getValueOfPrioritizedOption(a,"isUsedLabelAsZeroCount")};},_updateIconInButton:function(d,c,b){var a=d.find("._icon"),e=!b.isHiddenIcon;a.length&&a.toggle(e);},_updateClassButton:function(d,c,b){var f=this._conf.iconToggleClassname,a=f[0]||"",e=f[1]||"";if(c){d.addClass(a).removeClass(e).attr(b,"true");}else{d.addClass(e).removeClass(a).attr(b,"false");}},_updateLabelInButton:function(e,d,c){var b=d||0,a=e.find("._label"),f=true;if(c.isHiddenLabel){f=false;}else{if(c.isUsedLabelAsZeroCount){f=b===0;}}a.length&&a.toggle(f);},_update:function(a){var c=a.length,b=this._conf.contentCountPerOnceRequest,d=Math.ceil(c/b),e,g,f;if(!c){return;}for(e=0;e<d;e++){g=Math.max(0,e*b);f=Math.min(g+b,c);this._requestContentList(a.slice(g,f));}},_getFilteredTarget:function(b,c){var a=jQuery();if(!b){a=a.add("."+this._conf.moduleClassname);}else{jQuery(b).each(jQuery.proxy(function(d,e){if(jQuery(e).hasClass(this._conf.moduleClassname)){a=a.add(e);}else{a=a.add("."+this._conf.moduleClassname,e);}},this));}if(!c){a=a.filter("[data-loaded!='1']");}return a;},update:function(a,b){this._update(this._getFilteredTarget(a,b));},increase:function(a){this._requestReaction(a,true);},decrease:function(a){this._requestReaction(a,false);},_isFace:function(a){return a.attr("data-facetype")==="1";},_toNum:function(a){if(!a){return 0;}return Number(a.replace(/[^-\.\d]/g,""));},_destroy:function(){this._detachEvent();}};reaction.instance=(new reaction.Controller(reaction.conf(),reaction.message)).update();